<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up - WEVERSE</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <!-- Scroll Progress Bar -->
    <div class="scroll-progress"></div>

    <!-- Loader -->
    <div class="loader" id="loader">
        <div class="loader-text">
            <span>W</span><span>E</span><span>V</span><span>E</span><span>R</span><span>S</span><span>E</span>
        </div>
    </div>

    <!-- Custom Cursor -->
    <div class="cursor" id="cursor"></div>
    <div class="cursor-dot" id="cursorDot"></div>

    <!-- Header -->
    <header class="header" id="header">
        <div class="container">
            <div class="header-inner">
                <a href="../index.html" class="logo">WE<span>V</span>ERSE</a>
                <nav class="nav" id="nav">
                    <a href="../index.html" data-i18n="nav.main">Main</a>
                    <a href="company.html" data-i18n="nav.company">Company</a>
                    <a href="product.html" data-i18n="nav.product">Product</a>
                    <a href="shopping.html" data-i18n="nav.shop">Shop</a>
                    <a href="login.html" class="nav-auth" data-i18n="nav.login">Login</a>
                    <a href="cart.html" class="nav-cart">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <circle cx="9" cy="21" r="1"/>
                            <circle cx="20" cy="21" r="1"/>
                            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
                        </svg>
                        <span class="cart-count" id="cartCount">0</span>
                    </a>
                </nav>
                <div class="nav-toggle" id="navToggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>
    </header>

    <!-- Signup Section -->
    <section class="auth-section">
        <div class="container">
            <div class="auth-container" data-animate>
                <div class="auth-header">
                    <h1 data-i18n="signup.title">Create Account</h1>
                    <p>Join WEVERSE for exclusive benefits</p>
                </div>

                <form class="auth-form" id="signupForm" onsubmit="handleSignup(event)">
                    <div class="form-group">
                        <label for="fullName">Name</label>
                        <input type="text" id="fullName" name="fullName" placeholder="Enter your name" required>
                    </div>

                    <div class="form-group">
                        <label for="username" data-i18n="signup.username">ID</label>
                        <input type="text" id="username" name="username" placeholder="Enter your ID" required minlength="4" pattern="[a-zA-Z0-9_]+">
                        <span class="password-hint">Letters, numbers, and underscores only (min 4 characters)</span>
                    </div>

                    <div class="form-group">
                        <label for="password" data-i18n="signup.password">Password</label>
                        <div class="password-input">
                            <input type="password" id="password" name="password" placeholder="Create a password" required minlength="8">
                            <button type="button" class="password-toggle" onclick="togglePassword('password')">
                                <svg class="eye-open" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                    <circle cx="12" cy="12" r="3"/>
                                </svg>
                                <svg class="eye-closed" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="display:none;">
                                    <path d="M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19m-6.72-1.07a3 3 0 11-4.24-4.24"/>
                                    <line x1="1" y1="1" x2="23" y2="23"/>
                                </svg>
                            </button>
                        </div>
                        <span class="password-hint">At least 8 characters</span>
                    </div>

                    <div class="form-group">
                        <label for="confirmPassword" data-i18n="signup.confirm">Confirm Password</label>
                        <div class="password-input">
                            <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Confirm your password" required>
                            <button type="button" class="password-toggle" onclick="togglePassword('confirmPassword')">
                                <svg class="eye-open" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                    <circle cx="12" cy="12" r="3"/>
                                </svg>
                                <svg class="eye-closed" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="display:none;">
                                    <path d="M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19m-6.72-1.07a3 3 0 11-4.24-4.24"/>
                                    <line x1="1" y1="1" x2="23" y2="23"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="referrer">Referrer (Sponsor) *</label>
                        <div class="referrer-input">
                            <input type="text" id="referrer" name="referrer" placeholder="Enter referrer ID" required>
                            <button type="button" class="btn-referrer-check" onclick="checkReferrer()">Verify</button>
                        </div>
                        <div id="referrerResult" class="referrer-result"></div>
                        <span class="password-hint">Enter your referrer's ID and click Verify (Required)</span>
                    </div>

                    <div class="form-options">
                        <label class="checkbox-label">
                            <input type="checkbox" id="terms" required>
                            <span class="checkmark"></span>
                            <span>I agree to the <a href="#" class="terms-link">Terms of Service</a> and <a href="#" class="terms-link">Privacy Policy</a></span>
                        </label>
                    </div>

                    <div class="form-options">
                        <label class="checkbox-label">
                            <input type="checkbox" id="newsletter">
                            <span class="checkmark"></span>
                            <span>Subscribe to newsletter for updates and offers</span>
                        </label>
                    </div>

                    <button type="submit" class="btn btn-primary btn-full"><span data-i18n="signup.submit">Create Account</span></button>
                </form>

                <div class="auth-footer">
                    <p>Already have an account? <a href="login.html">Sign in</a></p>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-grid">
                <div class="footer-brand">
                    <a href="../index.html" class="logo">WE<span>V</span>ERSE</a>
                    <p data-i18n="footer.desc">Premium healthcare that elevates the value of life. Where science meets innovation to create your healthier tomorrow.</p>
                </div>
                <div class="footer-col">
                    <h4 class="footer-title" data-i18n="footer.menu">Menu</h4>
                    <div class="footer-links">
                        <a href="../index.html" data-i18n="nav.main">Main</a>
                        <a href="company.html" data-i18n="nav.company">Company</a>
                        <a href="product.html" data-i18n="nav.product">Product</a>
                        <a href="shopping.html" data-i18n="nav.shop">Shop</a>
                    </div>
                </div>
                <div class="footer-col">
                    <h4 class="footer-title" data-i18n="footer.products">Products</h4>
                    <div class="footer-links">
                        <a href="products/new-bornaid.html">New-BornAid</a>
                        <a href="products/alpha-gpc.html">Alpha GPC</a>
                        <a href="products/nano-lutein.html">Nano Lutein</a>
                        <a href="products/super-prostaid.html">Super Prost Aid</a>
                        <a href="products/joint-care.html">Joint Care</a>
                    </div>
                </div>
                <div class="footer-col">
                    <h4 class="footer-title" data-i18n="footer.contact">Contact</h4>
                    <div class="footer-links">
                        <a href="mailto:weverse.one@gmail.com">weverse.one@gmail.com</a>
                        <a href="#">Singapore</a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p class="footer-copyright" data-i18n="footer.copyright">&copy; 2025 WEVERSE. All rights reserved.</p>
                </div>
        </div>
    </footer>
    <!-- Floating Action Button -->
    <div class="fab-container" id="fabContainer">
        <a href="cart.html" class="fab-item fab-cart" title="Cart">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <circle cx="9" cy="21" r="1"/>
                <circle cx="20" cy="21" r="1"/>
                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
            </svg>
            <span class="fab-cart-count" id="fabCartCount">0</span>
        </a>
        <a href="account.html" class="fab-item fab-account" title="My Account">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
            </svg>
        </a>
        <button class="fab-item fab-lang" id="fabLang" title="Language" onclick="toggleLanguage()">中</button>

        <button class="fab-toggle" id="fabToggle" aria-label="Quick Menu">
            <svg class="fab-icon-menu" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <circle cx="12" cy="12" r="1"/>
                <circle cx="12" cy="5" r="1"/>
                <circle cx="12" cy="19" r="1"/>
            </svg>
            <svg class="fab-icon-close" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
        </button>
    </div>



    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/supabase.js"></script>
    <script src="../js/main.js"></script>
    <script>
        // Store verified referrer info
        let verifiedReferrer = null;

        // Verify referrer
        async function checkReferrer() {
            const referrerInput = document.getElementById('referrer');
            const resultDiv = document.getElementById('referrerResult');
            const referrerUsername = referrerInput.value.trim();

            if (!referrerUsername) {
                resultDiv.innerHTML = '<span class="referrer-error">Please enter a referrer ID.</span>';
                resultDiv.className = 'referrer-result error';
                verifiedReferrer = null;
                return;
            }

            // Search in member data
            let referrerMember = null;

            // Search in weverseData
            if (typeof weverseData !== 'undefined') {
                referrerMember = await weverseData.getMemberByUsername(referrerUsername);
            }

            // Also search in localStorage
            if (!referrerMember) {
                const members = JSON.parse(localStorage.getItem('weverseMembers')) || [];
                referrerMember = members.find(m => m.username === referrerUsername);
            }

            if (referrerMember) {
                verifiedReferrer = {
                    id: referrerMember.id,
                    username: referrerMember.username,
                    name: referrerMember.name
                };
                resultDiv.innerHTML = `<span class="referrer-success">✓ ${referrerMember.name} (${referrerMember.username})</span>`;
                resultDiv.className = 'referrer-result success';
            } else {
                verifiedReferrer = null;
                resultDiv.innerHTML = '<span class="referrer-error">✗ ID does not exist.</span>';
                resultDiv.className = 'referrer-result error';
            }
        }

        // Toggle password visibility
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const btn = input.parentElement.querySelector('.password-toggle');
            const eyeOpen = btn.querySelector('.eye-open');
            const eyeClosed = btn.querySelector('.eye-closed');

            if (input.type === 'password') {
                input.type = 'text';
                eyeOpen.style.display = 'none';
                eyeClosed.style.display = 'block';
            } else {
                input.type = 'password';
                eyeOpen.style.display = 'block';
                eyeClosed.style.display = 'none';
            }
        }

        // Handle signup
        async function handleSignup(e) {
            e.preventDefault();

            const fullName = document.getElementById('fullName').value.trim();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const terms = document.getElementById('terms').checked;
            const newsletter = document.getElementById('newsletter').checked;

            // Validation
            if (username.length < 4) {
                showToast('ID must be at least 4 characters.');
                return;
            }

            if (!/^[a-zA-Z0-9_]+$/.test(username)) {
                showToast('ID can only contain letters, numbers, and underscores.');
                return;
            }

            if (password !== confirmPassword) {
                showToast('Passwords do not match.');
                return;
            }

            if (password.length < 8) {
                showToast('Password must be at least 8 characters.');
                return;
            }

            if (!terms) {
                showToast('Please agree to the Terms of Service.');
                return;
            }

            // Referrer is required and must be verified
            const referrerInput = document.getElementById('referrer').value.trim();
            if (!referrerInput) {
                showToast('Referrer ID is required.');
                return;
            }
            if (!verifiedReferrer) {
                showToast('Please verify your referrer ID.');
                return;
            }

            // Check if username already exists
            const users = JSON.parse(localStorage.getItem('weverseUsers')) || [];
            if (users.find(u => u.username === username)) {
                showToast('This ID is already in use.');
                return;
            }

            // Check if username exists in data store
            if (typeof weverseData !== 'undefined') {
                const existingMember = await weverseData.getMemberByUsername(username);
                if (existingMember) {
                    showToast('This ID is already in use.');
                    return;
                }
            }

            // Create new user
            const newUser = {
                fullName,
                username,
                password,
                newsletter,
                createdAt: new Date().toISOString()
            };

            users.push(newUser);
            localStorage.setItem('weverseUsers', JSON.stringify(users));

            // Add member to Supabase
            try {
                if (typeof weverseData !== 'undefined') {
                    const result = await weverseData.addMember({
                        name: fullName,
                        username: username,
                        password: password,
                        rank: 'general',
                        memberType: 'consumer',
                        referrer: verifiedReferrer ? {
                            id: verifiedReferrer.id,
                            username: verifiedReferrer.username,
                            name: verifiedReferrer.name
                        } : null
                    });

                    if (result.error) {
                        console.error('Error adding member to Supabase:', result.error);
                    }
                }
            } catch (err) {
                console.error('Error adding member to data store:', err);
            }

            // Auto login
            const sessionData = {
                username: newUser.username,
                fullName: newUser.fullName,
                loggedIn: true,
                loginTime: new Date().toISOString()
            };

            localStorage.setItem('weverseSession', JSON.stringify(sessionData));

            // Update profile
            localStorage.setItem('weverseProfile', JSON.stringify({
                fullName: newUser.fullName
            }));

            showToast('Account created successfully! Redirecting...');

            setTimeout(() => {
                window.location.href = 'account.html';
            }, 1000);
        }

        // Check if already logged in
        document.addEventListener('DOMContentLoaded', function() {
            const session = JSON.parse(localStorage.getItem('weverseSession')) ||
                           JSON.parse(sessionStorage.getItem('weverseSession'));

            if (session && session.loggedIn) {
                window.location.href = 'account.html';
            }

            // Animate
            setTimeout(() => {
                document.querySelectorAll('[data-animate]').forEach((el, index) => {
                    setTimeout(() => {
                        el.classList.add('animated');
                    }, index * 100);
                });
            }, 100);
        });
    </script>
</body>
</html>
