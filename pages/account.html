<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Account - WEVERSE</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        /* 산하 조직도 스타일 */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .downline-node {
            position: relative;
            margin-bottom: 1rem;
        }

        .downline-card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0;
            min-width: 160px;
            display: inline-block;
            cursor: pointer;
            transition: all 0.2s;
        }

        .downline-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .downline-card-header {
            background: #1a1f2e;
            color: #fff;
            padding: 0.4rem 0.6rem;
            border-radius: 7px 7px 0 0;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .downline-card-body {
            padding: 0.6rem;
        }

        .downline-card-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            margin-bottom: 0.25rem;
        }

        .downline-card-row:last-child {
            margin-bottom: 0;
        }

        .downline-card-label {
            color: var(--text-secondary);
        }

        .downline-card-value {
            font-weight: 500;
        }

        .downline-rank {
            display: inline-block;
            padding: 0.1rem 0.3rem;
            border-radius: 3px;
            font-size: 0.65rem;
            font-weight: 500;
        }

        /* 등급별 색상 */
        .rank-crown_diamond { background: rgba(245,158,11,0.15); color: #f59e0b; }
        .rank-red_diamond { background: rgba(239,68,68,0.15); color: #ef4444; }
        .rank-blue_diamond { background: rgba(59,130,246,0.15); color: #3b82f6; }
        .rank-diamond { background: rgba(168,85,247,0.15); color: #a855f7; }
        .rank-manager { background: rgba(16,185,129,0.15); color: #10b981; }
        .rank-general { background: rgba(107,114,128,0.15); color: #6b7280; }

        /* 아코디언 스타일 */
        .downline-children {
            margin-left: 1.5rem;
            padding-left: 1rem;
            border-left: 2px solid var(--border);
            margin-top: 0.5rem;
        }

        .downline-children.collapsed {
            display: none;
        }

        /* 전체 접기/펼치기 버튼 스타일 */
        .downline-toggle-btns {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .downline-toggle-btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
        }

        .downline-toggle-btn.expand {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: #ffffff !important;
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
        }

        .downline-toggle-btn.expand svg {
            stroke: #ffffff !important;
        }

        .downline-toggle-btn.expand:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }

        .downline-toggle-btn.collapse {
            background: #2a2f3e;
            color: #e5e7eb !important;
            border: 1px solid #3f4451;
        }

        .downline-toggle-btn.collapse svg {
            stroke: #e5e7eb !important;
        }

        .downline-toggle-btn.collapse:hover {
            background: #353a4a;
            border-color: #8b5cf6;
            color: #8b5cf6 !important;
        }

        .downline-toggle-btn.collapse:hover svg {
            stroke: #8b5cf6 !important;
        }

        .downline-expand-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            color: #fff;
            font-size: 0.7rem;
            font-weight: bold;
            cursor: pointer;
            margin-left: 0.5rem;
            vertical-align: middle;
            border: none;
        }

        .downline-expand-btn:hover {
            opacity: 0.8;
        }

        .pv-personal { color: #3b82f6; }
        .pv-group { color: #10b981; }
    </style>
</head>
<body>
    <!-- Scroll Progress Bar -->
    <div class="scroll-progress"></div>

    <!-- Loader -->
    <div class="loader" id="loader">
        <div class="loader-text">
            <span>W</span><span>E</span><span>V</span><span>E</span><span>R</span><span>S</span><span>E</span>
        </div>
    </div>

    <!-- Custom Cursor -->
    <div class="cursor" id="cursor"></div>
    <div class="cursor-dot" id="cursorDot"></div>

    <!-- Header -->
    <header class="header" id="header">
        <div class="container">
            <div class="header-inner">
                <a href="../index.html" class="logo">WE<span>V</span>ERSE</a>
                <nav class="nav" id="nav">
                    <a href="../index.html" data-i18n="nav.main">Main</a>
                    <a href="company.html" data-i18n="nav.company">Company</a>
                    <a href="product.html" data-i18n="nav.product">Product</a>
                    <a href="shopping.html" data-i18n="nav.shop">Shop</a>
                    <a href="login.html" class="nav-auth" data-i18n="nav.login">Login</a>
                    <a href="cart.html" class="nav-cart">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <circle cx="9" cy="21" r="1"/>
                            <circle cx="20" cy="21" r="1"/>
                            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
                        </svg>
                        <span class="cart-count" id="cartCount">0</span>
                    </a>
                </nav>
                <div class="nav-toggle" id="navToggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>
    </header>

    <!-- Page Hero -->
    <section class="page-hero">
        <div class="container">
            <p class="hero-subtitle" data-animate><span data-i18n="account.subtitle">Welcome Back</span></p>
            <h1 data-animate data-delay="1"><span data-i18n="account.title">My Account</span></h1>
        </div>
    </section>

    <!-- Account Content -->
    <section class="section" style="padding-top: 0;">
        <div class="container">
            <div class="account-grid">
                <!-- Sidebar -->
                <aside class="account-sidebar" data-animate>
                    <div class="account-profile">
                        <div class="profile-avatar">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                                <circle cx="12" cy="7" r="4"/>
                            </svg>
                        </div>
                        <h3 id="profileName">Guest User</h3>
                    </div>
                    <nav class="account-nav">
                        <button class="account-nav-item active" data-tab="orders">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/>
                                <line x1="3" y1="6" x2="21" y2="6"/>
                                <path d="M16 10a4 4 0 01-8 0"/>
                            </svg>
                            Order History
                        </button>
                        <button class="account-nav-item" data-tab="points">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 6v6l4 2"/>
                            </svg>
                            My Points
                        </button>
                        <button class="account-nav-item" data-tab="profile">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                                <circle cx="12" cy="7" r="4"/>
                            </svg>
                            Profile Settings
                        </button>
                        <button class="account-nav-item" data-tab="address">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/>
                                <circle cx="12" cy="10" r="3"/>
                            </svg>
                            Saved Addresses
                        </button>
                        <button class="account-nav-item" data-tab="wishlist">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/>
                            </svg>
                            Wishlist
                        </button>
                        <button class="account-nav-item" data-tab="downline">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <rect x="3" y="3" width="7" height="7"/>
                                <rect x="14" y="3" width="7" height="7"/>
                                <rect x="14" y="14" width="7" height="7"/>
                                <rect x="3" y="14" width="7" height="7"/>
                            </svg>
                            조직도
                        </button>
                        <button class="account-nav-item logout-btn" onclick="handleLogout()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/>
                                <polyline points="16 17 21 12 16 7"/>
                                <line x1="21" y1="12" x2="9" y2="12"/>
                            </svg>
                            Logout
                        </button>
                    </nav>
                </aside>

                <!-- Main Content -->
                <main class="account-main">
                    <!-- Orders Tab -->
                    <div class="account-tab active" id="tab-orders" data-animate data-delay="1">
                        <div class="account-tab-header">
                            <h2>Order History</h2>
                            <p>View and track your orders</p>
                        </div>

                        <!-- Orders List -->
                        <div class="orders-list" id="ordersList">
                            <!-- Orders will be rendered by JavaScript -->
                        </div>

                        <!-- Empty State -->
                        <div class="account-empty" id="ordersEmpty" style="display: none;">
                            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/>
                                <line x1="3" y1="6" x2="21" y2="6"/>
                                <path d="M16 10a4 4 0 01-8 0"/>
                            </svg>
                            <h3>No orders yet</h3>
                            <p>When you place an order, it will appear here.</p>
                            <a href="shopping.html" class="btn btn-primary">Start Shopping</a>
                        </div>
                    </div>

                    <!-- Points Tab -->
                    <div class="account-tab" id="tab-points">
                        <div class="account-tab-header">
                            <h2>My Points</h2>
                            <p>Manage your points and rewards</p>
                        </div>

                        <!-- Point Balance Cards -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                            <div style="background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%); color: white; padding: 1.5rem; border-radius: 12px; text-align: center;">
                                <div style="font-size: 0.9rem; opacity: 0.9;">W페이</div>
                                <div style="font-size: 2rem; font-weight: 700;" id="accountRPay">₩0</div>
                                <div style="font-size: 0.85rem; opacity: 0.8;">KRW Balance</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #2196f3 0%, #03a9f4 100%); color: white; padding: 1.5rem; border-radius: 12px; text-align: center;">
                                <div style="font-size: 0.9rem; opacity: 0.9;">P포인트</div>
                                <div style="font-size: 2rem; font-weight: 700;" id="accountPPoint">$0</div>
                                <div style="font-size: 0.85rem; opacity: 0.8;">Earned Points</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%); color: white; padding: 1.5rem; border-radius: 12px; text-align: center;">
                                <div style="font-size: 0.9rem; opacity: 0.9;">C포인트</div>
                                <div style="font-size: 2rem; font-weight: 700;" id="accountCPoint">$0</div>
                                <div style="font-size: 0.85rem; opacity: 0.8;">Bonus Points</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #9c27b0 0%, #673ab7 100%); color: white; padding: 1.5rem; border-radius: 12px; text-align: center;">
                                <div style="font-size: 0.9rem; opacity: 0.9;">T포인트</div>
                                <div style="font-size: 2rem; font-weight: 700;" id="accountTPoint">$0</div>
                                <div style="font-size: 0.85rem; opacity: 0.8;">Transfer Points</div>
                            </div>
                        </div>

                        <!-- Member Type -->
                        <div style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-size: 0.85rem; color: var(--text-secondary);">회원 유형</div>
                                    <div style="font-size: 1.25rem; font-weight: 600;" id="accountMemberType">회원</div>
                                </div>
                                <span id="accountMemberBadge" style="padding: 0.5rem 1rem; background: rgba(33, 150, 243, 0.1); color: #2196f3; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">Member</span>
                            </div>
                        </div>

                        <!-- Point Actions -->
                        <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
                            <a href="points.html" class="btn btn-primary" style="flex: 1; min-width: 150px; justify-content: center;">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M12 6v6l4 2"/>
                                </svg>
                                포인트 상세 보기
                            </a>
                            <a href="rpay-charge.html" class="btn btn-outline" style="flex: 1; min-width: 150px; justify-content: center;">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="1" x2="12" y2="23"/>
                                    <path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/>
                                </svg>
                                W페이 충전
                            </a>
                            <a href="point-transfer.html" class="btn btn-outline" style="flex: 1; min-width: 150px; justify-content: center;">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="22" y1="2" x2="11" y2="13"/>
                                    <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                                </svg>
                                포인트 전송
                            </a>
                            <a href="withdrawal.html" class="btn btn-outline" id="withdrawalLink" style="flex: 1; min-width: 150px; justify-content: center; display: none;">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                                    <polyline points="17 8 12 3 7 8"/>
                                    <line x1="12" y1="3" x2="12" y2="15"/>
                                </svg>
                                출금 신청
                            </a>
                        </div>
                    </div>

                    <!-- Profile Tab -->
                    <div class="account-tab" id="tab-profile">
                        <div class="account-tab-header">
                            <h2>Profile Settings</h2>
                            <p>Manage your account information</p>
                        </div>

                        <div class="account-form">
                            <div class="form-group">
                                <label for="editFullName">이름</label>
                                <input type="text" id="editFullName" placeholder="이름을 입력하세요">
                            </div>
                            <div class="form-actions">
                                <button class="btn btn-primary" onclick="saveProfile()">Save Changes</button>
                            </div>
                        </div>

                        <!-- Password Change Section -->
                        <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border);">
                            <h3 style="margin-bottom: 1rem; font-size: 1.1rem;">비밀번호 변경</h3>
                            <div class="account-form">
                                <div class="form-group">
                                    <label for="currentPassword">현재 비밀번호</label>
                                    <input type="password" id="currentPassword" placeholder="현재 비밀번호 입력">
                                </div>
                                <div class="form-group">
                                    <label for="newPassword">새 비밀번호</label>
                                    <input type="password" id="newPassword" placeholder="새 비밀번호 입력 (최소 6자)">
                                </div>
                                <div class="form-group">
                                    <label for="confirmPassword">새 비밀번호 확인</label>
                                    <input type="password" id="confirmPassword" placeholder="새 비밀번호 다시 입력">
                                </div>
                                <div class="form-actions">
                                    <button class="btn btn-primary" onclick="changePassword()">비밀번호 변경</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Address Tab -->
                    <div class="account-tab" id="tab-address">
                        <div class="account-tab-header">
                            <h2>Saved Addresses</h2>
                            <p>Manage your shipping addresses</p>
                        </div>

                        <div class="address-list" id="addressList">
                            <!-- Addresses will be rendered by JavaScript -->
                        </div>

                        <div class="account-empty" id="addressEmpty" style="display: none;">
                            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/>
                                <circle cx="12" cy="10" r="3"/>
                            </svg>
                            <h3>No saved addresses</h3>
                            <p>Add an address for faster checkout.</p>
                            <button class="btn btn-primary" onclick="showAddAddressForm()">Add Address</button>
                        </div>

                        <!-- Add Address Form -->
                        <div class="add-address-form" id="addAddressForm" style="display: none;">
                            <h3>Add New Address</h3>
                            <div class="form-grid">
                                <div class="form-group full-width">
                                    <label for="newAddressLabel">Address Label</label>
                                    <input type="text" id="newAddressLabel" placeholder="e.g., Home, Office">
                                </div>
                                <div class="form-group full-width">
                                    <label for="newAddress">Street Address</label>
                                    <input type="text" id="newAddress" placeholder="Enter street address">
                                </div>
                                <div class="form-group">
                                    <label for="newCity">City</label>
                                    <input type="text" id="newCity" placeholder="Enter city">
                                </div>
                                <div class="form-group">
                                    <label for="newState">State / Province</label>
                                    <input type="text" id="newState" placeholder="Enter state">
                                </div>
                                <div class="form-group">
                                    <label for="newZipcode">ZIP Code</label>
                                    <input type="text" id="newZipcode" placeholder="Enter ZIP code">
                                </div>
                                <div class="form-group">
                                    <label for="newCountry">Country</label>
                                    <select id="newCountry">
                                        <option value="Singapore">Singapore</option>
                                        <option value="United States">United States</option>
                                        <option value="South Korea">South Korea</option>
                                        <option value="Japan">Japan</option>
                                        <option value="Malaysia">Malaysia</option>
                                        <option value="Australia">Australia</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-actions">
                                <button class="btn btn-outline" onclick="hideAddAddressForm()">Cancel</button>
                                <button class="btn btn-primary" onclick="saveAddress()">Save Address</button>
                            </div>
                        </div>

                        <button class="btn btn-outline add-address-btn" id="addAddressBtn" onclick="showAddAddressForm()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                            Add New Address
                        </button>
                    </div>

                    <!-- Wishlist Tab -->
                    <div class="account-tab" id="tab-wishlist">
                        <div class="account-tab-header">
                            <h2>Wishlist</h2>
                            <p>Products you've saved for later</p>
                        </div>

                        <div class="wishlist-grid" id="wishlistGrid">
                            <!-- Wishlist items will be rendered by JavaScript -->
                        </div>

                        <div class="account-empty" id="wishlistEmpty">
                            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/>
                            </svg>
                            <h3>Your wishlist is empty</h3>
                            <p>Save products you like for later.</p>
                            <a href="shopping.html" class="btn btn-primary">Browse Products</a>
                        </div>
                    </div>

                    <!-- Downline Tab (내 산하) -->
                    <div class="account-tab" id="tab-downline">
                        <div class="account-tab-header">
                            <h2>내 산하</h2>
                            <p>나의 산하 조직 현황</p>
                        </div>

                        <!-- 산하 통계 -->
                        <div class="downline-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                            <div style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 1rem; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);" id="downlineTotalCount">0</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">산하 회원수</div>
                            </div>
                            <div style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 1rem; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #3b82f6;" id="downlinePersonalPV">0</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">개인 PV</div>
                            </div>
                            <div style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 1rem; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #10b981;" id="downlineGroupPV">0</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">산하 PV</div>
                            </div>
                        </div>

                        <!-- 전체 접기/펼치기 버튼 -->
                        <div class="downline-toggle-btns">
                            <button class="downline-toggle-btn expand" onclick="expandAllDownlines()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                    <path d="M12 5v14M5 12h14"/>
                                </svg>
                                전체 펼치기
                            </button>
                            <button class="downline-toggle-btn collapse" onclick="collapseAllDownlines()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                    <path d="M5 12h14"/>
                                </svg>
                                전체 접기
                            </button>
                        </div>

                        <!-- 산하 조직도 컨테이너 -->
                        <div class="downline-tree-container" style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; min-height: 300px;">
                            <div id="downlineTree" style="overflow-x: auto;">
                                <!-- 조직도가 여기에 렌더링됩니다 -->
                                <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                    <div class="loading-spinner" style="width: 30px; height: 30px; border: 2px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
                                    로딩 중...
                                </div>
                            </div>
                        </div>

                        <!-- 빈 상태 -->
                        <div class="account-empty" id="downlineEmpty" style="display: none;">
                            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <rect x="3" y="3" width="7" height="7"/>
                                <rect x="14" y="3" width="7" height="7"/>
                                <rect x="14" y="14" width="7" height="7"/>
                                <rect x="3" y="14" width="7" height="7"/>
                            </svg>
                            <h3>산하 회원이 없습니다</h3>
                            <p>아직 추천한 회원이 없습니다.</p>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </section>

    <!-- Order Detail Modal -->
    <div class="modal" id="orderModal">
        <div class="modal-overlay" onclick="closeOrderModal()"></div>
        <div class="modal-content">
            <button class="modal-close" onclick="closeOrderModal()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
            <div class="modal-body" id="orderModalBody">
                <!-- Order details will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-grid">
                <div class="footer-brand">
                    <a href="../index.html" class="logo">WE<span>V</span>ERSE</a>
                    <p data-i18n="footer.desc">Premium healthcare that elevates the value of life. Where science meets innovation to create your healthier tomorrow.</p>
                </div>
                <div class="footer-col">
                    <h4 class="footer-title" data-i18n="footer.menu">Menu</h4>
                    <div class="footer-links">
                        <a href="../index.html" data-i18n="nav.main">Main</a>
                        <a href="company.html" data-i18n="nav.company">Company</a>
                        <a href="product.html" data-i18n="nav.product">Product</a>
                        <a href="shopping.html" data-i18n="nav.shop">Shop</a>
                    </div>
                </div>
                <div class="footer-col">
                    <h4 class="footer-title" data-i18n="footer.products">Products</h4>
                    <div class="footer-links">
                        <a href="products/new-bornaid.html">New-BornAid</a>
                        <a href="products/alpha-gpc.html">Alpha GPC</a>
                        <a href="products/nano-lutein.html">Nano Lutein</a>
                        <a href="products/super-prostaid.html">Super Prost Aid</a>
                        <a href="products/joint-care.html">Joint Care</a>
                    </div>
                </div>
                <div class="footer-col">
                    <h4 class="footer-title" data-i18n="footer.contact">Contact</h4>
                    <div class="footer-links">
                        <a href="mailto:weverse.one@gmail.com">weverse.one@gmail.com</a>
                        <a href="#">Singapore</a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p class="footer-copyright" data-i18n="footer.copyright">&copy; 2025 WEVERSE. All rights reserved.</p>
                </div>
        </div>
    </footer>
    <!-- Floating Action Button -->
    <div class="fab-container" id="fabContainer">
        <a href="cart.html" class="fab-item fab-cart" title="Cart">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <circle cx="9" cy="21" r="1"/>
                <circle cx="20" cy="21" r="1"/>
                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
            </svg>
            <span class="fab-cart-count" id="fabCartCount">0</span>
        </a>
        <a href="account.html" class="fab-item fab-account" title="My Account">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
            </svg>
        </a>
        <button class="fab-item fab-lang" id="fabLang" title="Language" onclick="toggleLanguage()">中</button>

        <button class="fab-toggle" id="fabToggle" aria-label="Quick Menu">
            <svg class="fab-icon-menu" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <circle cx="12" cy="12" r="1"/>
                <circle cx="12" cy="5" r="1"/>
                <circle cx="12" cy="19" r="1"/>
            </svg>
            <svg class="fab-icon-close" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
        </button>
    </div>



    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/supabase.js"></script>
    <script src="../js/main.js"></script>
    <script>
        // Initialize data
        let orders = [];
        let profile = {};
        let addresses = [];
        let currentMember = null;

        // Load data from localStorage
        async function loadAccountData() {
            // Get current user session
            let session = null;
            try {
                const localSession = JSON.parse(localStorage.getItem('weverseSession'));
                const storageSession = JSON.parse(sessionStorage.getItem('weverseSession'));
                session = (storageSession && storageSession.loggedIn) ? storageSession :
                          (localSession && localSession.loggedIn) ? localSession :
                          (storageSession || localSession);
            } catch (e) {}

            // Load all orders
            const storedOrders = localStorage.getItem('weverseOrders');
            const allOrders = storedOrders ? JSON.parse(storedOrders) : [];

            // Check for last order and add to history if not already there
            const lastOrder = localStorage.getItem('weverseLastOrder');
            if (lastOrder) {
                const order = JSON.parse(lastOrder);
                const exists = allOrders.find(o => o.orderNumber === order.orderNumber || o.id === order.orderNumber);
                if (!exists) {
                    allOrders.unshift(order);
                    localStorage.setItem('weverseOrders', JSON.stringify(allOrders));
                }
            }

            // Filter orders for current user only
            if (session && session.username) {
                orders = allOrders.filter(order => {
                    // Check if order belongs to current user by username
                    if (order.customer && order.customer.username === session.username) return true;
                    if (order.shipping && order.shipping.username === session.username) return true;
                    return false;
                });
            } else {
                // Not logged in - show orders from lastOrder only (guest orders)
                orders = lastOrder ? [JSON.parse(lastOrder)] : [];
            }

            // Load profile from session
            const storedProfile = localStorage.getItem('weverseProfile');
            if (session) {
                // Use session data for profile
                profile = storedProfile ? JSON.parse(storedProfile) : {
                    fullName: session.fullName || session.name || ''
                };
            } else {
                profile = storedProfile ? JSON.parse(storedProfile) : {
                    fullName: ''
                };
            }

            // Load addresses
            const storedAddresses = localStorage.getItem('weverseAddresses');
            addresses = storedAddresses ? JSON.parse(storedAddresses) : [];

            // Load member data and points
            await loadMemberPoints();

            // Render all data
            renderProfile();
            renderOrders();
            renderAddresses();
        }

        // Load member points
        async function loadMemberPoints() {
            let session = null;
            try {
                const localSession = JSON.parse(localStorage.getItem('weverseSession'));
                const storageSession = JSON.parse(sessionStorage.getItem('weverseSession'));
                session = (storageSession && storageSession.loggedIn) ? storageSession :
                          (localSession && localSession.loggedIn) ? localSession :
                          (storageSession || localSession);
            } catch (e) {}
            if (!session || (!session.loggedIn && !session.username)) return;

            // Find member in weverseData
            if (typeof weverseData !== 'undefined') {
                const members = await weverseData.getMembers();
                currentMember = members.find(m => m.username === session.username);

                if (currentMember) {
                    const points = currentMember.points || { rPay: 0, pPoint: 0, cPoint: 0, tPoint: 0 };

                    // Update point displays
                    document.getElementById('accountRPay').textContent = '₩' + (points.rPay || 0).toLocaleString();
                    document.getElementById('accountPPoint').textContent = '$' + (points.pPoint || 0).toLocaleString();
                    document.getElementById('accountCPoint').textContent = '$' + (points.cPoint || 0).toLocaleString();
                    document.getElementById('accountTPoint').textContent = '$' + (points.tPoint || 0).toLocaleString();

                    // Update member type - show as "회원" for all
                    document.getElementById('accountMemberType').textContent = '회원';
                    const badge = document.getElementById('accountMemberBadge');
                    badge.textContent = 'Member';
                    badge.style.background = 'rgba(33, 150, 243, 0.1)';
                    badge.style.color = '#2196f3';
                    // Show withdrawal link for all members
                    document.getElementById('withdrawalLink').style.display = 'flex';
                }
            }
        }

        // Render profile
        function renderProfile() {
            const name = profile.fullName || 'Guest User';
            document.getElementById('profileName').textContent = name;

            // Fill form
            document.getElementById('editFullName').value = profile.fullName || '';
        }

        // Save profile
        function saveProfile() {
            profile = {
                fullName: document.getElementById('editFullName').value
            };

            localStorage.setItem('weverseProfile', JSON.stringify(profile));
            renderProfile();
            showToast('Profile saved successfully!');
        }

        // Change password
        async function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // Validation
            if (!currentPassword || !newPassword || !confirmPassword) {
                showToast('모든 필드를 입력해주세요.');
                return;
            }

            if (newPassword.length < 6) {
                showToast('새 비밀번호는 최소 6자 이상이어야 합니다.');
                return;
            }

            if (newPassword !== confirmPassword) {
                showToast('새 비밀번호가 일치하지 않습니다.');
                return;
            }

            if (!currentMember) {
                showToast('로그인이 필요합니다.');
                return;
            }

            // Verify current password
            const verifyResult = await weverseData.verifyMemberPassword(currentMember.id, currentPassword);
            if (verifyResult.error) {
                showToast(verifyResult.error);
                return;
            }

            // Update password
            const updateResult = await weverseData.updateMemberPassword(currentMember.id, newPassword);
            if (updateResult.error) {
                showToast(updateResult.error);
                return;
            }

            // Clear form
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';

            showToast('비밀번호가 성공적으로 변경되었습니다.');
        }

        // Render orders
        function renderOrders() {
            const ordersList = document.getElementById('ordersList');
            const ordersEmpty = document.getElementById('ordersEmpty');

            if (orders.length === 0) {
                ordersList.style.display = 'none';
                ordersEmpty.style.display = 'block';
                return;
            }

            ordersList.style.display = 'block';
            ordersEmpty.style.display = 'none';

            ordersList.innerHTML = orders.map(order => {
                const date = new Date(order.orderDate).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                const itemCount = order.items.reduce((sum, item) => sum + item.quantity, 0);
                const status = getOrderStatus(order.orderDate);

                return `
                    <div class="order-card" onclick="viewOrderDetail('${order.orderNumber}')">
                        <div class="order-card-header">
                            <div class="order-info">
                                <span class="order-number">${order.orderNumber}</span>
                                <span class="order-date">${date}</span>
                            </div>
                            <span class="order-status ${status.class}">${status.text}</span>
                        </div>
                        <div class="order-card-body">
                            <div class="order-items-preview">
                                ${order.items.slice(0, 2).map(item => `
                                    <span class="order-item-name">${item.name}${item.quantity > 1 ? ` x${item.quantity}` : ''}</span>
                                `).join('')}
                                ${order.items.length > 2 ? `<span class="order-more">+${order.items.length - 2} more</span>` : ''}
                            </div>
                            <div class="order-total">
                                <span>Total</span>
                                <strong>$${order.total.toFixed(2)}</strong>
                            </div>
                        </div>
                        <div class="order-card-footer">
                            <span class="view-details">View Details <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg></span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Get order status based on date
        function getOrderStatus(orderDate) {
            const now = new Date();
            const ordered = new Date(orderDate);
            const diffDays = Math.floor((now - ordered) / (1000 * 60 * 60 * 24));

            if (diffDays < 1) {
                return { text: 'Processing', class: 'status-processing' };
            } else if (diffDays < 3) {
                return { text: 'Shipped', class: 'status-shipped' };
            } else {
                return { text: 'Delivered', class: 'status-delivered' };
            }
        }

        // View order detail
        function viewOrderDetail(orderNumber) {
            const order = orders.find(o => o.orderNumber === orderNumber);
            if (!order) return;

            const date = new Date(order.orderDate).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            const status = getOrderStatus(order.orderDate);
            const paymentMethodNames = {
                'card': 'Credit / Debit Card',
                'paypal': 'PayPal',
                'bank': 'Bank Transfer'
            };

            const modalBody = document.getElementById('orderModalBody');
            modalBody.innerHTML = `
                <div class="order-detail">
                    <div class="order-detail-header">
                        <div>
                            <h2>Order ${order.orderNumber}</h2>
                            <p class="order-detail-date">${date}</p>
                        </div>
                        <span class="order-status ${status.class}">${status.text}</span>
                    </div>

                    <div class="order-detail-section">
                        <h3>Items Ordered</h3>
                        <div class="order-detail-items">
                            ${order.items.map(item => `
                                <div class="order-detail-item">
                                    <div class="item-info">
                                        <span class="item-name">${item.name}</span>
                                        <span class="item-qty">Qty: ${item.quantity}</span>
                                    </div>
                                    <span class="item-price">$${(item.price * item.quantity).toFixed(2)}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="order-detail-grid">
                        <div class="order-detail-section">
                            <h3>Shipping Address</h3>
                            <p>${order.shipping.fullName}</p>
                            <p>${order.shipping.address}</p>
                            <p>${order.shipping.city}, ${order.shipping.state} ${order.shipping.zipcode}</p>
                            <p>${order.shipping.country}</p>
                        </div>

                        <div class="order-detail-section">
                            <h3>Payment Summary</h3>
                            <div class="payment-rows">
                                <div class="payment-row">
                                    <span>Subtotal</span>
                                    <span>$${order.subtotal.toFixed(2)}</span>
                                </div>
                                <div class="payment-row">
                                    <span>Shipping</span>
                                    <span>${order.shippingCost === 0 ? 'FREE' : '$' + order.shippingCost.toFixed(2)}</span>
                                </div>
                                ${order.discountAmount > 0 ? `
                                    <div class="payment-row discount">
                                        <span>Discount (${order.discount}%)</span>
                                        <span>-$${order.discountAmount.toFixed(2)}</span>
                                    </div>
                                ` : ''}
                                <div class="payment-row total">
                                    <span>Total</span>
                                    <span>$${order.total.toFixed(2)}</span>
                                </div>
                            </div>
                            <p class="payment-method">Paid with ${paymentMethodNames[order.paymentMethod] || 'Credit Card'}</p>
                        </div>
                    </div>

                    <div class="order-detail-actions">
                        <button class="btn btn-outline" onclick="window.print()">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <polyline points="6 9 6 2 18 2 18 9"/>
                                <path d="M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/>
                                <rect x="6" y="14" width="12" height="8"/>
                            </svg>
                            Print
                        </button>
                        <a href="shopping.html" class="btn btn-primary">Order Again</a>
                    </div>
                </div>
            `;

            document.getElementById('orderModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // Close order modal
        function closeOrderModal() {
            document.getElementById('orderModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        // Render addresses
        function renderAddresses() {
            const addressList = document.getElementById('addressList');
            const addressEmpty = document.getElementById('addressEmpty');
            const addAddressBtn = document.getElementById('addAddressBtn');

            if (addresses.length === 0) {
                addressList.innerHTML = '';
                addressEmpty.style.display = 'block';
                addAddressBtn.style.display = 'none';
                return;
            }

            addressEmpty.style.display = 'none';
            addAddressBtn.style.display = 'flex';

            addressList.innerHTML = addresses.map((addr, index) => `
                <div class="address-card">
                    <div class="address-card-header">
                        <span class="address-label">${addr.label || 'Address ' + (index + 1)}</span>
                        <div class="address-actions">
                            <button class="address-action" onclick="deleteAddress(${index})">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3 6 5 6 21 6"/>
                                    <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="address-card-body">
                        <p>${addr.address}</p>
                        <p>${addr.city}, ${addr.state} ${addr.zipcode}</p>
                        <p>${addr.country}</p>
                    </div>
                </div>
            `).join('');
        }

        // Show add address form
        function showAddAddressForm() {
            document.getElementById('addAddressForm').style.display = 'block';
            document.getElementById('addAddressBtn').style.display = 'none';
            document.getElementById('addressEmpty').style.display = 'none';
        }

        // Hide add address form
        function hideAddAddressForm() {
            document.getElementById('addAddressForm').style.display = 'none';
            if (addresses.length === 0) {
                document.getElementById('addressEmpty').style.display = 'block';
            } else {
                document.getElementById('addAddressBtn').style.display = 'flex';
            }
        }

        // Save address
        function saveAddress() {
            const newAddress = {
                label: document.getElementById('newAddressLabel').value,
                address: document.getElementById('newAddress').value,
                city: document.getElementById('newCity').value,
                state: document.getElementById('newState').value,
                zipcode: document.getElementById('newZipcode').value,
                country: document.getElementById('newCountry').value
            };

            if (!newAddress.address || !newAddress.city) {
                showToast('Please fill in required fields');
                return;
            }

            addresses.push(newAddress);
            localStorage.setItem('weverseAddresses', JSON.stringify(addresses));

            // Clear form
            document.getElementById('newAddressLabel').value = '';
            document.getElementById('newAddress').value = '';
            document.getElementById('newCity').value = '';
            document.getElementById('newState').value = '';
            document.getElementById('newZipcode').value = '';

            hideAddAddressForm();
            renderAddresses();
            showToast('Address saved successfully!');
        }

        // Delete address
        function deleteAddress(index) {
            if (confirm('Are you sure you want to delete this address?')) {
                addresses.splice(index, 1);
                localStorage.setItem('weverseAddresses', JSON.stringify(addresses));
                renderAddresses();
                showToast('Address deleted');
            }
        }

        // Tab navigation
        document.querySelectorAll('.account-nav-item').forEach(btn => {
            btn.addEventListener('click', function() {
                const tabId = this.dataset.tab;

                // Update nav
                document.querySelectorAll('.account-nav-item').forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                // Update tabs
                document.querySelectorAll('.account-tab').forEach(tab => tab.classList.remove('active'));
                document.getElementById('tab-' + tabId).classList.add('active');
            });
        });

        // Close modal on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeOrderModal();
            }
        });

        // Handle logout
        function handleLogout() {
            // Clear session data
            localStorage.removeItem('weverseSession');
            sessionStorage.removeItem('weverseSession');

            // Show toast message
            showToast('Logged out successfully');

            // Redirect to login page after a short delay
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 500);
        }

        // =====================================
        // 산하 조직도 관련 코드
        // =====================================

        // 등급 표시 정보
        const RANK_DISPLAY = {
            'general': { name: '일반', color: '#6b7280' },
            'manager': { name: '매니저', color: '#10b981' },
            'diamond': { name: '다이아몬드', color: '#a855f7' },
            'blue_diamond': { name: '블루다이아몬드', color: '#3b82f6' },
            'red_diamond': { name: '레드다이아몬드', color: '#ef4444' },
            'crown_diamond': { name: '크라운다이아몬드', color: '#f59e0b' }
        };

        let allMembersForDownline = [];
        let memberPVMap = {};
        let downlineExpandedNodes = new Set();

        // 산하 조직도 로드
        async function loadDownlineData() {
            if (!currentMember) {
                document.getElementById('downlineTree').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        로그인이 필요합니다.
                    </div>
                `;
                return;
            }

            try {
                // 모든 회원 데이터 로드
                allMembersForDownline = await weverseData.getMembers();

                // 주문 데이터로 PV 계산
                const orders = await weverseData.getOrders();
                calculateMemberPVForDownline(orders);

                // 내 산하 회원 찾기
                const myDownlines = findDownlines(currentMember.id);

                // 통계 업데이트
                updateDownlineStats(myDownlines);

                // 조직도 렌더링
                renderDownlineTree(myDownlines);
            } catch (error) {
                console.error('산하 조직도 로드 오류:', error);
                document.getElementById('downlineTree').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        데이터를 불러오는 중 오류가 발생했습니다.
                    </div>
                `;
            }
        }

        // 회원별 PV 계산
        function calculateMemberPVForDownline(orders) {
            memberPVMap = {};

            orders.filter(o => o.status !== 'cancelled').forEach(order => {
                const memberId = order.customer?.memberId;
                if (memberId) {
                    if (!memberPVMap[memberId]) {
                        memberPVMap[memberId] = { personal: 0, group: 0 };
                    }
                    memberPVMap[memberId].personal += order.totalPv || 0;
                }
            });
        }

        // 산하 회원 찾기 (재귀)
        function findDownlines(memberId) {
            const downlines = allMembersForDownline.filter(m =>
                m.referrer && m.referrer.id === memberId
            );

            return downlines.map(member => ({
                ...member,
                children: findDownlines(member.id)
            }));
        }

        // 산하 회원 수 계산 (재귀)
        function countDownlines(downlines) {
            let count = downlines.length;
            downlines.forEach(d => {
                count += countDownlines(d.children || []);
            });
            return count;
        }

        // 산하 PV 계산 (재귀)
        function calculateGroupPVForMember(memberId, downlines) {
            let groupPV = memberPVMap[memberId]?.personal || 0;

            downlines.forEach(child => {
                groupPV += calculateGroupPVForMember(child.id, child.children || []);
            });

            return groupPV;
        }

        // 통계 업데이트
        function updateDownlineStats(myDownlines) {
            const totalCount = countDownlines(myDownlines);
            const personalPV = memberPVMap[currentMember.id]?.personal || 0;
            const groupPV = calculateGroupPVForMember(currentMember.id, myDownlines);

            document.getElementById('downlineTotalCount').textContent = totalCount;
            document.getElementById('downlinePersonalPV').textContent = personalPV.toLocaleString() + ' PV';
            document.getElementById('downlineGroupPV').textContent = groupPV.toLocaleString() + ' PV';
        }

        // 산하 조직도 렌더링
        function renderDownlineTree(downlines) {
            const container = document.getElementById('downlineTree');
            const emptyEl = document.getElementById('downlineEmpty');

            if (downlines.length === 0) {
                container.style.display = 'none';
                emptyEl.style.display = 'block';
                return;
            }

            container.style.display = 'block';
            emptyEl.style.display = 'none';

            let html = '';
            downlines.forEach(member => {
                html += renderDownlineNode(member);
            });

            container.innerHTML = html;
        }

        // 노드 렌더링
        function renderDownlineNode(member) {
            const pv = memberPVMap[member.id] || { personal: 0, group: 0 };
            const hasChildren = (member.children || []).length > 0;
            const isExpanded = downlineExpandedNodes.has(member.id);

            const rankInfo = RANK_DISPLAY[member.rank] || RANK_DISPLAY['general'];
            const joinDate = member.joinDate ? new Date(member.joinDate).toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            }) : '-';

            // 산하 PV 계산
            const groupPV = calculateGroupPVForMember(member.id, member.children || []);

            let html = `
                <div class="downline-node" data-member-id="${member.id}">
                    <div class="downline-card">
                        <div class="downline-card-header">
                            ${member.id}/${member.name}
                        </div>
                        <div class="downline-card-body">
                            <div class="downline-card-row">
                                <span class="downline-card-label">가입일</span>
                                <span class="downline-card-value">${joinDate}</span>
                            </div>
                            <div class="downline-card-row">
                                <span class="downline-card-label">등급</span>
                                <span class="downline-rank rank-${member.rank}">${rankInfo.name}</span>
                            </div>
                            <div class="downline-card-row">
                                <span class="downline-card-label">개인PV</span>
                                <span class="downline-card-value pv-personal">${pv.personal.toLocaleString()}PV</span>
                            </div>
                            <div class="downline-card-row">
                                <span class="downline-card-label">산하PV</span>
                                <span class="downline-card-value pv-group">${groupPV.toLocaleString()}PV</span>
                            </div>
                        </div>
                    </div>
            `;

            // 자식이 있으면 확장 버튼과 자식 표시 (기본 펼침)
            if (hasChildren) {
                // 처음 로드 시 기본으로 펼쳐진 상태
                if (!downlineExpandedNodes.has(member.id) && !downlineExpandedNodes.has('_initialized_' + member.id)) {
                    downlineExpandedNodes.add(member.id);
                    downlineExpandedNodes.add('_initialized_' + member.id);
                }
                const isNodeExpanded = downlineExpandedNodes.has(member.id);

                html += `
                    <button class="downline-expand-btn" onclick="toggleDownlineNode('${member.id}')">
                        ${isNodeExpanded ? '-' : '+'}
                    </button>
                `;

                const collapsedClass = isNodeExpanded ? '' : 'collapsed';
                html += `<div class="downline-children ${collapsedClass}" id="downline-children-${member.id}">`;
                member.children.forEach(child => {
                    html += renderDownlineNode(child);
                });
                html += '</div>';
            }

            html += '</div>';
            return html;
        }

        // 노드 확장/축소
        function toggleDownlineNode(memberId) {
            if (downlineExpandedNodes.has(memberId)) {
                downlineExpandedNodes.delete(memberId);
            } else {
                downlineExpandedNodes.add(memberId);
            }

            // 해당 노드의 자식만 토글
            const childrenEl = document.getElementById('downline-children-' + memberId);
            const btn = document.querySelector(`[data-member-id="${memberId}"] .downline-expand-btn`);

            if (childrenEl) {
                childrenEl.classList.toggle('collapsed');
            }
            if (btn) {
                btn.textContent = downlineExpandedNodes.has(memberId) ? '-' : '+';
            }
        }

        // 전체 펼치기
        function expandAllDownlines() {
            const container = document.getElementById('downlineTree');
            if (!container) return;

            const allChildrenEls = container.querySelectorAll('.downline-children');
            const allBtns = container.querySelectorAll('.downline-expand-btn');

            allChildrenEls.forEach(el => {
                el.classList.remove('collapsed');
                el.style.display = 'block';
                const memberId = el.id.replace('downline-children-', '');
                downlineExpandedNodes.add(memberId);
            });

            allBtns.forEach(btn => {
                btn.textContent = '-';
            });
        }

        // 전체 접기
        function collapseAllDownlines() {
            const container = document.getElementById('downlineTree');
            if (!container) return;

            const allChildrenEls = container.querySelectorAll('.downline-children');
            const allBtns = container.querySelectorAll('.downline-expand-btn');

            allChildrenEls.forEach(el => {
                el.classList.add('collapsed');
                el.style.display = 'none';
                const memberId = el.id.replace('downline-children-', '');
                downlineExpandedNodes.delete(memberId);
            });

            allBtns.forEach(btn => {
                btn.textContent = '+';
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Debug: Check session state
            const localSession = localStorage.getItem('weverseSession');
            const sessionSession = sessionStorage.getItem('weverseSession');
            console.log('Account page - localStorage session:', localSession);
            console.log('Account page - sessionStorage session:', sessionSession);

            loadAccountData();

            // Animate elements
            setTimeout(() => {
                document.querySelectorAll('[data-animate]').forEach((el, index) => {
                    setTimeout(() => {
                        el.classList.add('animated');
                    }, index * 100);
                });
            }, 100);
        });

        // 탭 전환 시 산하 데이터 로드
        document.querySelectorAll('.account-nav-item').forEach(btn => {
            btn.addEventListener('click', function() {
                const tabId = this.dataset.tab;
                if (tabId === 'downline') {
                    loadDownlineData();
                }
            });
        });
    </script>
</body>
</html>
