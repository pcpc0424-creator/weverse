<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>통계 - WEVERSE 관리자</title>
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="css/admin.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="admin-wrapper">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="index.html" class="sidebar-logo">WE<span>V</span>ERSE</a>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">메인</div>
                </div>
                <a href="index.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
                        <polyline points="9,22 9,12 15,12 15,22"/>
                    </svg>
                    대시보드
                </a>
                <div class="nav-section">
                    <div class="nav-section-title">관리</div>
                </div>
                <a href="products.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/>
                        <polyline points="3.27,6.96 12,12.01 20.73,6.96"/>
                        <line x1="12" y1="22.08" x2="12" y2="12"/>
                    </svg>
                    상품 관리
                </a>
                <a href="orders.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/>
                        <line x1="3" y1="6" x2="21" y2="6"/>
                        <path d="M16 10a4 4 0 01-8 0"/>
                    </svg>
                    주문 관리
                </a>
                <a href="members.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 00-3-3.87"/>
                        <path d="M16 3.13a4 4 0 010 7.75"/>
                    </svg>
                    회원 관리
                </a>
                <a href="points.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 6v6l4 2"/>
                    </svg>
                    포인트 관리
                </a>
                <a href="ppoint-earning.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>
                    </svg>
                    P포인트 적립 상세
                </a>
                <a href="statistics.html" class="nav-item active">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="20" x2="18" y2="10"/>
                        <line x1="12" y1="20" x2="12" y2="4"/>
                        <line x1="6" y1="20" x2="6" y2="14"/>
                    </svg>
                    통계
                </a>
                <div class="nav-section">
                    <div class="nav-section-title">시스템</div>
                </div>
                <a href="settings.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/>
                    </svg>
                    시스템 설정
                </a>
            </nav>
            <div class="sidebar-footer">
                <div class="sidebar-user">
                    <div class="sidebar-user-avatar">A</div>
                    <div class="sidebar-user-info">
                        <div class="sidebar-user-name" id="adminUserName">관리자</div>
                        <div class="sidebar-user-role">최고 관리자</div>
                    </div>
                </div>
                <button class="logout-btn" id="logoutBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/>
                        <polyline points="16,17 21,12 16,7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                    로그아웃
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="admin-header">
                <div class="header-left">
                    <button class="menu-toggle" id="menuToggle">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="3" y1="12" x2="21" y2="12"/>
                            <line x1="3" y1="6" x2="21" y2="6"/>
                            <line x1="3" y1="18" x2="21" y2="18"/>
                        </svg>
                    </button>
                    <h1 class="page-title">통계</h1>
                </div>
                <div class="header-right">
                    <a href="../index.html" class="back-to-site">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/>
                            <polyline points="15,3 21,3 21,9"/>
                            <line x1="10" y1="14" x2="21" y2="3"/>
                        </svg>
                        사이트 보기
                    </a>
                </div>
            </header>

            <!-- Content -->
            <div class="content-area">
                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-info">
                            <h3>오늘 매출</h3>
                            <div class="stat-value" id="statTodaySales">₩0</div>
                            <div class="stat-change" id="statTodaySalesChange"></div>
                        </div>
                        <div class="stat-icon sales">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="1" x2="12" y2="23"/>
                                <path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info">
                            <h3>오늘 주문</h3>
                            <div class="stat-value" id="statTodayOrders">0건</div>
                            <div class="stat-change" id="statTodayOrdersChange"></div>
                        </div>
                        <div class="stat-icon orders">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/>
                                <line x1="3" y1="6" x2="21" y2="6"/>
                                <path d="M16 10a4 4 0 01-8 0"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info">
                            <h3>오늘 방문자</h3>
                            <div class="stat-value" id="statTodayVisitors">0명</div>
                            <div class="stat-change" id="statTodayVisitorsChange"></div>
                        </div>
                        <div class="stat-icon customers">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info">
                            <h3>평균 주문금액</h3>
                            <div class="stat-value" id="statAvgOrder">₩0</div>
                            <div class="stat-change" id="statAvgOrderChange"></div>
                        </div>
                        <div class="stat-icon products">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 6v6l4 2"/>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Charts Row 1 -->
                <div class="stats-grid" style="grid-template-columns: 2fr 1fr;">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">매출 추이</h2>
                            <select class="form-control form-select" style="width: auto;" id="salesTrendPeriod" onchange="updateSalesTrend()">
                                <option value="7">최근 7일</option>
                                <option value="30" selected>최근 30일</option>
                                <option value="90">최근 3개월</option>
                            </select>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" style="position: relative; height: 300px;">
                                <canvas id="salesTrendChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">상품별 매출 비율</h2>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" style="position: relative; height: 300px;">
                                <canvas id="productPieChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Row 2 -->
                <div class="stats-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">접속자 통계</h2>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" style="position: relative; height: 250px;">
                                <canvas id="visitorTrendChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">주문 상태 현황</h2>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" style="position: relative; height: 250px;">
                                <canvas id="orderStatusChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Top Products Table -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">베스트 상품</h2>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>순위</th>
                                        <th>상품명</th>
                                        <th>판매수량</th>
                                        <th>매출액</th>
                                        <th>비율</th>
                                    </tr>
                                </thead>
                                <tbody id="topProductsBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/supabase.js"></script>
    <script src="js/admin.js"></script>
    <script>
        let salesTrendChart = null;

        async function initStatistics() {
            await updateStatCards();
            await initSalesTrendChart();
            await initProductPieChart();
            initVisitorTrendChart();
            await initOrderStatusChart();
            await renderTopProducts();
        }

        async function updateStatCards() {
            const orders = await weverseData.getOrders();
            const visitors = JSON.parse(localStorage.getItem('weverseVisitors')) || {};
            const today = new Date().toISOString().split('T')[0];
            const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];

            // Today's orders
            const todayOrders = orders.filter(o => new Date(o.orderDate).toISOString().split('T')[0] === today);
            const yesterdayOrders = orders.filter(o => new Date(o.orderDate).toISOString().split('T')[0] === yesterday);

            // Today's sales
            const todaySales = todayOrders.reduce((sum, o) => sum + (o.total || 0), 0);
            const yesterdaySales = yesterdayOrders.reduce((sum, o) => sum + (o.total || 0), 0);

            // Today's visitors
            const todayVisitors = visitors[today] || 0;
            const yesterdayVisitors = visitors[yesterday] || 0;

            // Average order value
            const avgOrder = orders.length > 0 ? orders.reduce((sum, o) => sum + (o.total || 0), 0) / orders.length : 0;

            // Update display
            document.getElementById('statTodaySales').textContent = '₩' + todaySales.toLocaleString();
            document.getElementById('statTodayOrders').textContent = todayOrders.length + '건';
            document.getElementById('statTodayVisitors').textContent = todayVisitors + '명';
            document.getElementById('statAvgOrder').textContent = '₩' + Math.round(avgOrder).toLocaleString();

            // Update changes
            updateChangeDisplay('statTodaySalesChange', todaySales, yesterdaySales, '어제 대비');
            updateChangeDisplay('statTodayOrdersChange', todayOrders.length, yesterdayOrders.length, '어제 대비');
            updateChangeDisplay('statTodayVisitorsChange', todayVisitors, yesterdayVisitors, '어제 대비');
        }

        function updateChangeDisplay(elementId, current, previous, label) {
            const element = document.getElementById(elementId);
            if (!element) return;

            const upIcon = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23,6 13.5,15.5 8.5,10.5 1,18"/><polyline points="17,6 23,6 23,12"/></svg>`;
            const downIcon = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23,18 13.5,8.5 8.5,13.5 1,6"/><polyline points="17,18 23,18 23,12"/></svg>`;

            if (previous === 0) {
                element.className = 'stat-change positive';
                element.innerHTML = `${upIcon} ${label} +${current}`;
                return;
            }

            const change = ((current - previous) / previous * 100).toFixed(1);
            if (change > 0) {
                element.className = 'stat-change positive';
                element.innerHTML = `${upIcon} ${label} +${change}%`;
            } else if (change < 0) {
                element.className = 'stat-change negative';
                element.innerHTML = `${downIcon} ${label} ${change}%`;
            } else {
                element.className = 'stat-change';
                element.innerHTML = `${label} 0%`;
            }
        }

        async function initSalesTrendChart() {
            const ctx = document.getElementById('salesTrendChart');
            if (!ctx) return;

            const data = await getSalesTrendData(30);

            salesTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: '매출',
                        data: data.values,
                        borderColor: '#000',
                        backgroundColor: 'rgba(0, 0, 0, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { callback: v => '₩' + v.toLocaleString() }
                        }
                    }
                }
            });
        }

        async function updateSalesTrend() {
            const period = parseInt(document.getElementById('salesTrendPeriod').value);
            const data = await getSalesTrendData(period);
            if (salesTrendChart) {
                salesTrendChart.data.labels = data.labels;
                salesTrendChart.data.datasets[0].data = data.values;
                salesTrendChart.update();
            }
        }

        async function getSalesTrendData(days) {
            const orders = await weverseData.getOrders();
            const labels = [];
            const values = [];

            for (let i = days - 1; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];

                const dayOrders = orders.filter(o => new Date(o.orderDate).toISOString().split('T')[0] === dateStr);
                const dayTotal = dayOrders.reduce((sum, o) => sum + (o.total || 0), 0);

                labels.push(date.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' }));
                values.push(dayTotal);
            }

            return { labels, values };
        }

        async function initProductPieChart() {
            const ctx = document.getElementById('productPieChart');
            if (!ctx) return;

            const data = await getProductSalesData();

            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: data.labels,
                    datasets: [{
                        data: data.values,
                        backgroundColor: ['#000', '#333', '#666', '#999', '#ccc']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 11 } } }
                    }
                }
            });
        }

        async function getProductSalesData() {
            const orders = await weverseData.getOrders();
            const productSales = {};

            orders.forEach(order => {
                order.items.forEach(item => {
                    if (!productSales[item.name]) productSales[item.name] = 0;
                    productSales[item.name] += item.price * item.quantity;
                });
            });

            const sorted = Object.entries(productSales).sort((a, b) => b[1] - a[1]).slice(0, 5);
            return {
                labels: sorted.map(([name]) => name.length > 15 ? name.substring(0, 15) + '...' : name),
                values: sorted.map(([, value]) => value)
            };
        }

        function initVisitorTrendChart() {
            const ctx = document.getElementById('visitorTrendChart');
            if (!ctx) return;

            const visitors = JSON.parse(localStorage.getItem('weverseVisitors')) || {};
            const labels = [];
            const values = [];

            for (let i = 13; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];

                labels.push(date.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' }));
                values.push(visitors[dateStr] || 0);
            }

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '방문자',
                        data: values,
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        async function initOrderStatusChart() {
            const ctx = document.getElementById('orderStatusChart');
            if (!ctx) return;

            const stats = await weverseData.getOrderStats();

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['대기중', '처리중', '배송중', '배송완료', '취소됨'],
                    datasets: [{
                        data: [stats.pending, stats.processing, stats.shipped, stats.delivered, stats.cancelled || 0],
                        backgroundColor: ['#ff9800', '#2196f3', '#9c27b0', '#4caf50', '#f44336']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 11 } } }
                    }
                }
            });
        }

        async function renderTopProducts() {
            const orders = await weverseData.getOrders();
            const productStats = {};

            orders.forEach(order => {
                order.items.forEach(item => {
                    if (!productStats[item.name]) {
                        productStats[item.name] = { quantity: 0, revenue: 0 };
                    }
                    productStats[item.name].quantity += item.quantity;
                    productStats[item.name].revenue += item.price * item.quantity;
                });
            });

            const sorted = Object.entries(productStats).sort((a, b) => b[1].revenue - a[1].revenue);
            const totalRevenue = sorted.reduce((sum, [, stat]) => sum + stat.revenue, 0);

            const tbody = document.getElementById('topProductsBody');
            tbody.innerHTML = sorted.slice(0, 10).map(([name, stat], index) => {
                const percentage = totalRevenue > 0 ? ((stat.revenue / totalRevenue) * 100).toFixed(1) : 0;
                return `
                    <tr>
                        <td><strong>${index + 1}</strong></td>
                        <td>${name}</td>
                        <td>${stat.quantity}개</td>
                        <td class="fw-600">₩${stat.revenue.toLocaleString()}</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div style="flex: 1; height: 8px; background: #eee; border-radius: 4px;">
                                    <div style="width: ${percentage}%; height: 100%; background: #000; border-radius: 4px;"></div>
                                </div>
                                <span style="font-size: 0.8rem;">${percentage}%</span>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        document.addEventListener('DOMContentLoaded', initStatistics);
    </script>
</body>
</html>
