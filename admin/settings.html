<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>시스템 설정 - WEVERSE 관리자</title>
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="css/admin.css">
</head>
<body>
    <div class="admin-wrapper">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="index.html" class="sidebar-logo">WE<span>V</span>ERSE</a>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">메인</div>
                </div>
                <a href="index.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
                        <polyline points="9,22 9,12 15,12 15,22"/>
                    </svg>
                    대시보드
                </a>
                <div class="nav-section">
                    <div class="nav-section-title">관리</div>
                </div>
                <a href="products.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/>
                        <polyline points="3.27,6.96 12,12.01 20.73,6.96"/>
                        <line x1="12" y1="22.08" x2="12" y2="12"/>
                    </svg>
                    상품 관리
                </a>
                <a href="orders.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/>
                        <line x1="3" y1="6" x2="21" y2="6"/>
                        <path d="M16 10a4 4 0 01-8 0"/>
                    </svg>
                    주문 관리
                </a>
                <a href="members.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 00-3-3.87"/>
                        <path d="M16 3.13a4 4 0 010 7.75"/>
                    </svg>
                    회원 관리
                </a>
                <a href="organization.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"/>
                        <rect x="14" y="3" width="7" height="7"/>
                        <rect x="14" y="14" width="7" height="7"/>
                        <rect x="3" y="14" width="7" height="7"/>
                    </svg>
                    조직도
                </a>
                <a href="settlement.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                        <line x1="16" y1="2" x2="16" y2="6"/>
                        <line x1="8" y1="2" x2="8" y2="6"/>
                        <line x1="3" y1="10" x2="21" y2="10"/>
                        <path d="M8 14h.01M12 14h.01M16 14h.01M8 18h.01M12 18h.01M16 18h.01"/>
                    </svg>
                    마감 관리
                </a>
                <a href="points.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 6v6l4 2"/>
                    </svg>
                    포인트 관리
                </a>
                <a href="ppoint-earning.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>
                    </svg>
                    P포인트 적립 상세
                </a>
                <a href="statistics.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="20" x2="18" y2="10"/>
                        <line x1="12" y1="20" x2="12" y2="4"/>
                        <line x1="6" y1="20" x2="6" y2="14"/>
                    </svg>
                    통계
                </a>
                <div class="nav-section">
                    <div class="nav-section-title">시스템</div>
                </div>
                <a href="settings.html" class="nav-item active">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/>
                    </svg>
                    시스템 설정
                </a>
            </nav>
            <div class="sidebar-footer">
                <div class="sidebar-user">
                    <div class="sidebar-user-avatar">A</div>
                    <div class="sidebar-user-info">
                        <div class="sidebar-user-name" id="adminUserName">관리자</div>
                        <div class="sidebar-user-role">최고 관리자</div>
                    </div>
                </div>
                <button class="logout-btn" id="logoutBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/>
                        <polyline points="16,17 21,12 16,7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                    로그아웃
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="admin-header">
                <div class="header-left">
                    <button class="menu-toggle" id="menuToggle">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="3" y1="12" x2="21" y2="12"/>
                            <line x1="3" y1="6" x2="21" y2="6"/>
                            <line x1="3" y1="18" x2="21" y2="18"/>
                        </svg>
                    </button>
                    <h1 class="page-title">시스템 설정</h1>
                </div>
                <div class="header-right">
                    <a href="../index.html" class="back-to-site">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/>
                            <polyline points="15,3 21,3 21,9"/>
                            <line x1="10" y1="14" x2="21" y2="3"/>
                        </svg>
                        사이트 보기
                    </a>
                </div>
            </header>

            <!-- Content -->
            <div class="content-area">
                <!-- Settings Grid -->
                <div class="settings-grid">
                    <!-- Exchange Rate Settings -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="1" x2="12" y2="23"/>
                                    <path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/>
                                </svg>
                                환율 설정
                            </h2>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">USD → KRW 환율</label>
                                <div class="input-with-unit">
                                    <input type="number" class="form-control" id="exchangeRate" min="1" step="1">
                                    <span class="input-unit">원</span>
                                </div>
                                <p class="form-hint">1 USD = <span id="exchangeRatePreview">1,350</span> KRW</p>
                            </div>
                        </div>
                    </div>

                    <!-- P-Point Settings (Disabled) -->
                    <div class="card card-disabled">
                        <div class="card-header">
                            <h2 class="card-title">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/>
                                    <line x1="12" y1="17" x2="12.01" y2="17"/>
                                </svg>
                                P포인트 설정
                                <span class="badge-disabled">비활성</span>
                            </h2>
                        </div>
                        <div class="card-body">
                            <div class="disabled-notice">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <line x1="12" y1="8" x2="12" y2="12"/>
                                    <line x1="12" y1="16" x2="12.01" y2="16"/>
                                </svg>
                                <p>위버스 보상플랜 적용 전까지 P포인트 자동 적립 기능이 비활성화되어 있습니다.<br>현재는 수기로 관리됩니다.</p>
                            </div>
                            <div class="form-group">
                                <label class="form-label">P포인트 적립률</label>
                                <div class="input-with-unit">
                                    <input type="number" class="form-control" id="pPointRate" min="0" max="100" step="1" disabled>
                                    <span class="input-unit">%</span>
                                </div>
                                <p class="form-hint">PV 기준 P포인트 적립 비율 (예: 50% = PV 100 → 50 P포인트)</p>
                            </div>
                            <div class="form-group">
                                <label class="form-label">P포인트 적립일</label>
                                <div class="input-with-unit">
                                    <input type="number" class="form-control" id="pPointSettleDays" min="0" step="1" disabled>
                                    <span class="input-unit">일</span>
                                </div>
                                <p class="form-hint">배송완료 후 P포인트 적립까지 대기 기간</p>
                            </div>
                        </div>
                    </div>

                    <!-- Withdrawal Settings -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                                    <line x1="1" y1="10" x2="23" y2="10"/>
                                </svg>
                                출금 설정
                            </h2>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">최소 출금 금액</label>
                                <div class="input-with-unit">
                                    <input type="number" class="form-control" id="minWithdrawal" min="1" step="1">
                                    <span class="input-unit">USD</span>
                                </div>
                                <p class="form-hint">P포인트 출금 신청 시 최소 금액</p>
                            </div>
                        </div>
                    </div>

                    <!-- Shipping Companies -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="1" y="3" width="15" height="13"/>
                                    <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/>
                                    <circle cx="5.5" cy="18.5" r="2.5"/>
                                    <circle cx="18.5" cy="18.5" r="2.5"/>
                                </svg>
                                택배사 설정
                            </h2>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">등록된 택배사</label>
                                <div class="shipping-companies-list" id="shippingCompaniesList">
                                    <!-- Will be rendered by JavaScript -->
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">택배사 추가</label>
                                <div class="input-with-btn">
                                    <input type="text" class="form-control" id="newShippingCompany" placeholder="택배사명 입력">
                                    <button class="btn btn-primary btn-sm" onclick="addShippingCompany()">추가</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Save Button -->
                <div class="settings-actions">
                    <button class="btn btn-outline" onclick="resetSettings()">기본값 복원</button>
                    <button class="btn btn-primary" onclick="saveSettings()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
                            <polyline points="17,21 17,13 7,13 7,21"/>
                            <polyline points="7,3 7,8 15,8"/>
                        </svg>
                        설정 저장
                    </button>
                </div>

                <!-- Current Settings Preview -->
                <div class="card mt-2">
                    <div class="card-header">
                        <h2 class="card-title">현재 설정 미리보기</h2>
                    </div>
                    <div class="card-body">
                        <div class="settings-preview">
                            <div class="preview-item">
                                <span class="preview-label">환율</span>
                                <span class="preview-value" id="previewExchangeRate">1 USD = $1,350</span>
                            </div>
                            <div class="preview-item preview-disabled">
                                <span class="preview-label">P포인트 적립률</span>
                                <span class="preview-value" id="previewPPointRate">비활성 (수기 관리)</span>
                            </div>
                            <div class="preview-item preview-disabled">
                                <span class="preview-label">P포인트 적립 대기일</span>
                                <span class="preview-value" id="previewSettleDays">비활성 (수기 관리)</span>
                            </div>
                            <div class="preview-item">
                                <span class="preview-label">최소 출금 금액</span>
                                <span class="preview-value" id="previewMinWithdrawal">$50 (≈$67,500)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <style>
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        @media (max-width: 992px) {
            .settings-grid {
                grid-template-columns: 1fr;
            }
        }

        .card-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-title svg {
            color: var(--primary);
        }

        .input-with-unit {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .input-with-unit .form-control {
            flex: 1;
        }

        .input-unit {
            color: var(--text-secondary);
            font-size: 0.9rem;
            min-width: 40px;
        }

        .input-with-btn {
            display: flex;
            gap: 0.5rem;
        }

        .input-with-btn .form-control {
            flex: 1;
        }

        .form-hint {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }

        .shipping-companies-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .shipping-company-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: var(--bg-main);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
        }

        .shipping-company-tag button {
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
        }

        .shipping-company-tag button:hover {
            color: var(--danger);
        }

        .settings-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .settings-preview {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        @media (max-width: 768px) {
            .settings-preview {
                grid-template-columns: 1fr;
            }
        }

        .preview-item {
            display: flex;
            justify-content: space-between;
            padding: 1rem;
            background: var(--bg-main);
            border-radius: var(--radius-sm);
        }

        .preview-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .preview-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Disabled card styles */
        .card-disabled {
            opacity: 0.7;
            position: relative;
        }

        .card-disabled .form-control:disabled {
            background: var(--bg-main);
            cursor: not-allowed;
        }

        .badge-disabled {
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            background: var(--text-secondary);
            color: #fff;
            border-radius: 4px;
            margin-left: 0.5rem;
            font-weight: 500;
        }

        .disabled-notice {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 1rem;
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: var(--radius-sm);
            margin-bottom: 1.5rem;
        }

        .disabled-notice svg {
            color: #f59e0b;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .disabled-notice p {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin: 0;
            line-height: 1.5;
        }

        .preview-disabled {
            opacity: 0.5;
        }

        .preview-disabled .preview-value {
            font-style: italic;
            font-weight: 400;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/supabase.js"></script>
    <script src="js/admin.js"></script>
    <script>
        let currentSettings = {};

        async function initSettings() {
            currentSettings = await weverseData.getSettings();
            renderSettings();
            updatePreview();
        }

        function renderSettings() {
            document.getElementById('exchangeRate').value = currentSettings.exchangeRate || 1350;
            document.getElementById('pPointRate').value = currentSettings.pPointRate || 50;
            document.getElementById('pPointSettleDays').value = currentSettings.pPointSettleDays || 14;
            document.getElementById('minWithdrawal').value = currentSettings.minWithdrawal || 50;

            renderShippingCompanies();
        }

        function renderShippingCompanies() {
            const list = document.getElementById('shippingCompaniesList');
            const companies = currentSettings.shippingCompanies || ['CJ대한통운', '한진택배', '롯데택배', '우체국', '로젠택배'];

            list.innerHTML = companies.map((company, index) => `
                <span class="shipping-company-tag">
                    ${company}
                    <button onclick="removeShippingCompany(${index})" title="삭제">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </span>
            `).join('');
        }

        function addShippingCompany() {
            const input = document.getElementById('newShippingCompany');
            const name = input.value.trim();

            if (!name) {
                showToast('택배사명을 입력해주세요.');
                return;
            }

            if (!currentSettings.shippingCompanies) {
                currentSettings.shippingCompanies = [];
            }

            if (currentSettings.shippingCompanies.includes(name)) {
                showToast('이미 등록된 택배사입니다.');
                return;
            }

            currentSettings.shippingCompanies.push(name);
            input.value = '';
            renderShippingCompanies();
        }

        function removeShippingCompany(index) {
            if (currentSettings.shippingCompanies && currentSettings.shippingCompanies.length > 1) {
                currentSettings.shippingCompanies.splice(index, 1);
                renderShippingCompanies();
            } else {
                showToast('최소 1개의 택배사는 필요합니다.');
            }
        }

        function updatePreview() {
            const exchangeRate = parseInt(document.getElementById('exchangeRate').value) || 1350;
            const minWithdrawal = parseInt(document.getElementById('minWithdrawal').value) || 50;

            document.getElementById('exchangeRatePreview').textContent = exchangeRate.toLocaleString();
            document.getElementById('previewExchangeRate').textContent = `1 USD = $${exchangeRate.toLocaleString()}`;
            // P포인트 설정은 비활성화 상태 - 미리보기 업데이트 안함
            document.getElementById('previewMinWithdrawal').textContent = `$${minWithdrawal} (≈$${(minWithdrawal * exchangeRate).toLocaleString()})`;
        }

        async function saveSettings() {
            const newSettings = {
                exchangeRate: parseInt(document.getElementById('exchangeRate').value) || 1350,
                pPointRate: parseInt(document.getElementById('pPointRate').value) || 50,
                pPointSettleDays: parseInt(document.getElementById('pPointSettleDays').value) || 14,
                minWithdrawal: parseInt(document.getElementById('minWithdrawal').value) || 50,
                shippingCompanies: currentSettings.shippingCompanies || ['CJ대한통운', '한진택배', '롯데택배', '우체국', '로젠택배']
            };

            await weverseData.updateSettings(newSettings);
            currentSettings = newSettings;
            showToast('설정이 저장되었습니다.');
            updatePreview();
        }

        function resetSettings() {
            if (confirm('설정을 기본값으로 복원하시겠습니까?')) {
                currentSettings = {
                    exchangeRate: 1350,
                    pPointRate: 50,
                    pPointSettleDays: 14,
                    minWithdrawal: 50,
                    shippingCompanies: ['CJ대한통운', '한진택배', '롯데택배', '우체국', '로젠택배']
                };
                renderSettings();
                updatePreview();
                showToast('기본값으로 복원되었습니다.');
            }
        }

        // Update preview on input change
        document.getElementById('exchangeRate').addEventListener('input', updatePreview);
        // P포인트 설정은 비활성화 상태
        document.getElementById('minWithdrawal').addEventListener('input', updatePreview);

        // Initialize on load
        document.addEventListener('DOMContentLoaded', initSettings);
    </script>
</body>
</html>
