<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P포인트 적립 상세 관리 - WEVERSE 관리자</title>
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="css/admin.css">
    <style>
        .earning-info-banner {
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.1) 0%, rgba(3, 169, 244, 0.05) 100%);
            border: 1px solid rgba(33, 150, 243, 0.2);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .earning-info-banner svg {
            width: 32px;
            height: 32px;
            color: #2196f3;
            flex-shrink: 0;
        }
        .earning-info-banner .info-content h4 {
            font-size: 0.95rem;
            margin-bottom: 0.25rem;
            color: var(--text);
        }
        .earning-info-banner .info-content p {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin: 0;
        }
        .eligible-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            background: rgba(76, 175, 80, 0.1);
            color: #4caf50;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .not-eligible-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            background: rgba(158, 158, 158, 0.1);
            color: #9e9e9e;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .processed-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            background: rgba(33, 150, 243, 0.1);
            color: #2196f3;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .days-remaining {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        .pv-highlight {
            color: #9c27b0;
            font-weight: 600;
        }
        .ppoint-highlight {
            color: #2196f3;
            font-weight: 600;
        }
        .btn-process {
            padding: 0.35rem 0.75rem;
            font-size: 0.8rem;
        }
        .batch-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .select-all-wrapper {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <div class="admin-wrapper">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="index.html" class="sidebar-logo">WE<span>V</span>ERSE</a>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">메인</div>
                </div>
                <a href="index.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
                        <polyline points="9,22 9,12 15,12 15,22"/>
                    </svg>
                    대시보드
                </a>
                <div class="nav-section">
                    <div class="nav-section-title">관리</div>
                </div>
                <a href="products.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/>
                        <polyline points="3.27,6.96 12,12.01 20.73,6.96"/>
                        <line x1="12" y1="22.08" x2="12" y2="12"/>
                    </svg>
                    상품 관리
                </a>
                <a href="orders.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/>
                        <line x1="3" y1="6" x2="21" y2="6"/>
                        <path d="M16 10a4 4 0 01-8 0"/>
                    </svg>
                    주문 관리
                </a>
                <a href="members.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 00-3-3.87"/>
                        <path d="M16 3.13a4 4 0 010 7.75"/>
                    </svg>
                    회원 관리
                </a>
                <a href="points.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 6v6l4 2"/>
                    </svg>
                    포인트 관리
                </a>
                <a href="ppoint-earning.html" class="nav-item active">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>
                    </svg>
                    P포인트 적립 상세
                </a>
                <a href="statistics.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="20" x2="18" y2="10"/>
                        <line x1="12" y1="20" x2="12" y2="4"/>
                        <line x1="6" y1="20" x2="6" y2="14"/>
                    </svg>
                    통계
                </a>
                <div class="nav-section">
                    <div class="nav-section-title">시스템</div>
                </div>
                <a href="settings.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/>
                    </svg>
                    시스템 설정
                </a>
            </nav>
            <div class="sidebar-footer">
                <div class="sidebar-user">
                    <div class="sidebar-user-avatar">A</div>
                    <div class="sidebar-user-info">
                        <div class="sidebar-user-name" id="adminUserName">관리자</div>
                        <div class="sidebar-user-role">최고 관리자</div>
                    </div>
                </div>
                <button class="logout-btn" id="logoutBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/>
                        <polyline points="16,17 21,12 16,7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                    로그아웃
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="admin-header">
                <div class="header-left">
                    <button class="menu-toggle" id="menuToggle">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="3" y1="12" x2="21" y2="12"/>
                            <line x1="3" y1="6" x2="21" y2="6"/>
                            <line x1="3" y1="18" x2="21" y2="18"/>
                        </svg>
                    </button>
                    <h1 class="page-title">P포인트 적립 상세 관리</h1>
                </div>
                <div class="header-right">
                    <a href="../index.html" class="back-to-site">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/>
                            <polyline points="15,3 21,3 21,9"/>
                            <line x1="10" y1="14" x2="21" y2="3"/>
                        </svg>
                        사이트 보기
                    </a>
                </div>
            </header>

            <!-- Content -->
            <div class="content-area">
                <!-- Info Banner -->
                <div class="earning-info-banner">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="16" x2="12" y2="12"/>
                        <line x1="12" y1="8" x2="12.01" y2="8"/>
                    </svg>
                    <div class="info-content">
                        <h4>P포인트 적립 규칙</h4>
                        <p>회원 주문 완료 후 <strong id="earningDaysDisplay">14일</strong>이 지나면 PV의 <strong id="earningRateDisplay">50%</strong>가 P포인트로 적립됩니다. 적립 대상 주문을 확인하고 수동으로 처리하세요.</p>
                        <p style="margin-top: 0.5rem; font-size: 0.8rem;"><a href="settings.html" style="color: #2196f3;">시스템 설정</a>에서 적립률과 적립일을 변경할 수 있습니다.</p>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-info">
                            <h3>적립 대기</h3>
                            <div class="stat-value" id="statPending">0건</div>
                        </div>
                        <div class="stat-icon" style="background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%);">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <polyline points="12,6 12,12 16,14"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info">
                            <h3>적립 가능</h3>
                            <div class="stat-value" id="statEligible">0건</div>
                        </div>
                        <div class="stat-icon" style="background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%);">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20,6 9,17 4,12"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info">
                            <h3>적립 완료</h3>
                            <div class="stat-value" id="statProcessed">0건</div>
                        </div>
                        <div class="stat-icon" style="background: linear-gradient(135deg, #2196f3 0%, #03a9f4 100%);">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>
                                <polyline points="22,4 12,14.01 9,11.01"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info">
                            <h3>총 적립액</h3>
                            <div class="stat-value" id="statTotalEarned">$0</div>
                        </div>
                        <div class="stat-icon" style="background: linear-gradient(135deg, #9c27b0 0%, #673ab7 100%);">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="1" x2="12" y2="23"/>
                                <path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Filter Bar -->
                <div class="card">
                    <div class="card-body d-flex align-center justify-between">
                        <div class="batch-actions">
                            <label class="select-all-wrapper">
                                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                                <span>전체 선택</span>
                            </label>
                            <button class="btn btn-primary btn-process" onclick="processSelectedOrders()" id="batchProcessBtn" disabled>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="20,6 9,17 4,12"/>
                                </svg>
                                선택 항목 일괄 적립
                            </button>
                        </div>
                        <div class="d-flex align-center gap-2">
                            <select class="form-control form-select" style="width: 160px;" id="filterStatus" onchange="renderEarningOrders()">
                                <option value="all">전체 상태</option>
                                <option value="eligible">적립 가능</option>
                                <option value="pending">대기중 (14일 미만)</option>
                                <option value="processed">적립 완료</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Earnings Table -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">회원 주문 목록</h2>
                        <span class="text-muted" id="orderCount">총 0건</span>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <div class="table-responsive">
                            <table class="data-table" id="earningsTable">
                                <thead>
                                    <tr>
                                        <th style="width: 40px;"></th>
                                        <th>주문번호</th>
                                        <th>회원</th>
                                        <th>주문일</th>
                                        <th>총 PV</th>
                                        <th>예상 P포인트</th>
                                        <th>적립 상태</th>
                                        <th>관리</th>
                                    </tr>
                                </thead>
                                <tbody id="earningsTableBody">
                                    <!-- Orders will be loaded dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Recent Earnings History -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">최근 적립 내역</h2>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>적립일</th>
                                        <th>주문번호</th>
                                        <th>회원</th>
                                        <th>PV</th>
                                        <th>적립 P포인트</th>
                                    </tr>
                                </thead>
                                <tbody id="earningHistoryBody">
                                    <tr><td colspan="5" class="text-center text-muted">적립 내역이 없습니다.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/supabase.js"></script>
    <script src="js/admin.js"></script>
    <script>
        let earningDays = 14; // 주문일 포함 N일 후 적립 (설정에서 로드)
        let earningRate = 0.5; // 50% (설정에서 로드)
        let selectedOrders = new Set();

        // Initialize page
        async function initEarningPage() {
            // Get settings
            const settings = await weverseData.getSettings();
            earningRate = (settings.pPointRate || 50) / 100;
            earningDays = settings.pPointSettleDays || 14;

            // Update display with current settings
            document.getElementById('earningRateDisplay').textContent = (earningRate * 100) + '%';
            document.getElementById('earningDaysDisplay').textContent = earningDays + '일';

            await updateStats();
            await renderEarningOrders();
            await renderEarningHistory();
        }

        // Calculate days since order
        function getDaysSinceOrder(orderDate) {
            const now = new Date();
            const ordered = new Date(orderDate);
            const diffTime = now - ordered;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }

        // Check if order is eligible for P-point earning
        function isEligibleForEarning(order) {
            if (!order.memberId) return false;
            if (order.pvProcessed) return false;
            if (!order.totalPV || order.totalPV <= 0) return false;

            const daysSince = getDaysSinceOrder(order.orderDate);
            return daysSince >= earningDays;
        }

        // Update stats
        async function updateStats() {
            const orders = await weverseData.getOrders();
            const members = await weverseData.getMembers();

            let pending = 0;
            let eligible = 0;
            let processed = 0;
            let totalEarned = 0;

            orders.forEach(order => {
                const member = members.find(m => m.id === order.memberId);
                if (!member) return;
                if (!order.totalPV || order.totalPV <= 0) return;

                if (order.pvProcessed) {
                    processed++;
                    totalEarned += (order.totalPV * earningRate);
                } else {
                    const daysSince = getDaysSinceOrder(order.orderDate);
                    if (daysSince >= earningDays) {
                        eligible++;
                    } else {
                        pending++;
                    }
                }
            });

            document.getElementById('statPending').textContent = pending + '건';
            document.getElementById('statEligible').textContent = eligible + '건';
            document.getElementById('statProcessed').textContent = processed + '건';
            document.getElementById('statTotalEarned').textContent = '$' + totalEarned.toLocaleString();
        }

        // Render earning orders table
        async function renderEarningOrders() {
            const orders = await weverseData.getOrders();
            const members = await weverseData.getMembers();
            const filterStatus = document.getElementById('filterStatus').value;

            // Filter orders with PV
            let filteredOrders = orders.filter(order => {
                const member = members.find(m => m.id === order.memberId);
                return member && order.totalPV > 0;
            });

            // Apply filter
            if (filterStatus === 'eligible') {
                filteredOrders = filteredOrders.filter(o => !o.pvProcessed && getDaysSinceOrder(o.orderDate) >= earningDays);
            } else if (filterStatus === 'pending') {
                filteredOrders = filteredOrders.filter(o => !o.pvProcessed && getDaysSinceOrder(o.orderDate) < earningDays);
            } else if (filterStatus === 'processed') {
                filteredOrders = filteredOrders.filter(o => o.pvProcessed);
            }

            const tbody = document.getElementById('earningsTableBody');
            document.getElementById('orderCount').textContent = `총 ${filteredOrders.length}건`;

            if (filteredOrders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">해당하는 주문이 없습니다.</td></tr>';
                return;
            }

            tbody.innerHTML = filteredOrders.map(order => {
                const member = members.find(m => m.id === order.memberId);
                const daysSince = getDaysSinceOrder(order.orderDate);
                const daysRemaining = earningDays - daysSince;
                const expectedPPoint = Math.floor(order.totalPV * earningRate);
                const isEligible = !order.pvProcessed && daysSince >= earningDays;
                const isProcessed = order.pvProcessed;

                const orderDate = new Date(order.orderDate).toLocaleDateString('ko-KR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });

                let statusBadge;
                let actionBtn;

                if (isProcessed) {
                    statusBadge = '<span class="processed-badge">적립 완료</span>';
                    actionBtn = '<span class="text-muted" style="font-size: 0.75rem;">처리됨</span>';
                } else if (isEligible) {
                    statusBadge = '<span class="eligible-badge">적립 가능</span>';
                    actionBtn = `<button class="btn btn-primary btn-process" onclick="processEarning('${order.id}')">적립하기</button>`;
                } else {
                    statusBadge = `<span class="not-eligible-badge">대기중</span><br><span class="days-remaining">${daysRemaining}일 남음</span>`;
                    actionBtn = '<span class="text-muted" style="font-size: 0.75rem;">대기</span>';
                }

                const checkboxDisabled = isProcessed ? 'disabled' : '';
                const isChecked = selectedOrders.has(order.id) && isEligible ? 'checked' : '';

                return `
                    <tr>
                        <td>
                            <input type="checkbox" class="order-checkbox" value="${order.id}"
                                ${checkboxDisabled} ${isChecked}
                                onchange="toggleOrderSelection('${order.id}')"
                                ${!isEligible && !isProcessed ? 'disabled' : ''}>
                        </td>
                        <td><strong>#${order.id}</strong></td>
                        <td>
                            <div>
                                <div class="fw-500">${member?.name || '-'}</div>
                                <div class="text-muted" style="font-size: 0.75rem;">${member?.username || member?.id || '-'}</div>
                            </div>
                        </td>
                        <td>
                            <div>${orderDate}</div>
                            <div class="text-muted" style="font-size: 0.75rem;">${daysSince}일 전</div>
                        </td>
                        <td class="pv-highlight">${order.totalPV} PV</td>
                        <td class="ppoint-highlight">$${expectedPPoint}</td>
                        <td>${statusBadge}</td>
                        <td>${actionBtn}</td>
                    </tr>
                `;
            }).join('');

            updateBatchButton();
        }

        // Toggle order selection
        function toggleOrderSelection(orderId) {
            if (selectedOrders.has(orderId)) {
                selectedOrders.delete(orderId);
            } else {
                selectedOrders.add(orderId);
            }
            updateBatchButton();
        }

        // Toggle select all
        async function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll').checked;
            const checkboxes = document.querySelectorAll('.order-checkbox:not([disabled])');
            const orders = await weverseData.getOrders();

            checkboxes.forEach(cb => {
                const orderId = cb.value;
                const order = orders.find(o => o.id === orderId);
                if (order && isEligibleForEarning(order)) {
                    cb.checked = selectAll;
                    if (selectAll) {
                        selectedOrders.add(orderId);
                    } else {
                        selectedOrders.delete(orderId);
                    }
                }
            });

            await updateBatchButton();
        }

        // Update batch button state
        async function updateBatchButton() {
            const btn = document.getElementById('batchProcessBtn');
            const orders = await weverseData.getOrders();
            const eligibleSelected = Array.from(selectedOrders).filter(id => {
                const order = orders.find(o => o.id === id);
                return order && isEligibleForEarning(order);
            });
            btn.disabled = eligibleSelected.length === 0;
            btn.textContent = eligibleSelected.length > 0
                ? `선택 항목 일괄 적립 (${eligibleSelected.length}건)`
                : '선택 항목 일괄 적립';
        }

        // Process single order earning
        async function processEarning(orderId) {
            const orders = await weverseData.getOrders();
            const order = orders.find(o => o.id === orderId);
            if (!order) {
                showToast('주문을 찾을 수 없습니다.');
                return;
            }

            const members = await weverseData.getMembers();
            const member = members.find(m => m.id === order.memberId);
            if (!member) {
                showToast('회원을 찾을 수 없습니다.');
                return;
            }

            const pPointAmount = Math.floor(order.totalPV * earningRate);

            if (!confirm(`${member.name}님에게 P포인트 $${pPointAmount}를 적립하시겠습니까?\n\n주문번호: #${order.id}\n총 PV: ${order.totalPV}`)) {
                return;
            }

            // Process the earning
            const result = await processPPointEarning(order.id, member.id, pPointAmount);

            if (result.success) {
                showToast(`P포인트 $${pPointAmount}가 적립되었습니다.`);
                await updateStats();
                await renderEarningOrders();
                await renderEarningHistory();
            } else {
                showToast(result.error || '적립 처리에 실패했습니다.');
            }
        }

        // Process selected orders
        async function processSelectedOrders() {
            const allOrders = await weverseData.getOrders();
            const eligibleSelected = Array.from(selectedOrders).filter(id => {
                const order = allOrders.find(o => o.id === id);
                return order && isEligibleForEarning(order);
            });

            if (eligibleSelected.length === 0) {
                showToast('적립 가능한 주문이 선택되지 않았습니다.');
                return;
            }

            if (!confirm(`${eligibleSelected.length}건의 주문에 대해 P포인트를 일괄 적립하시겠습니까?`)) {
                return;
            }

            let successCount = 0;
            let totalEarned = 0;
            const members = await weverseData.getMembers();

            for (const orderId of eligibleSelected) {
                const order = allOrders.find(o => o.id === orderId);
                if (!order) continue;

                const member = members.find(m => m.id === order.memberId);
                if (!member) continue;

                const pPointAmount = Math.floor(order.totalPV * earningRate);
                const result = await processPPointEarning(order.id, member.id, pPointAmount);

                if (result.success) {
                    successCount++;
                    totalEarned += pPointAmount;
                }
            }

            selectedOrders.clear();
            document.getElementById('selectAll').checked = false;

            showToast(`${successCount}건 처리 완료! 총 $${totalEarned} P포인트 적립`);
            await updateStats();
            await renderEarningOrders();
            await renderEarningHistory();
        }

        // Process P-point earning
        async function processPPointEarning(orderId, memberId, pPointAmount) {
            try {
                // Update member points
                const members = JSON.parse(localStorage.getItem('weverseMembers')) || [];
                const memberIndex = members.findIndex(m => m.id === memberId);

                if (memberIndex === -1) {
                    return { success: false, error: '회원을 찾을 수 없습니다.' };
                }

                members[memberIndex].points = members[memberIndex].points || { rPay: 0, pPoint: 0, cPoint: 0, tPoint: 0 };
                members[memberIndex].points.pPoint = (members[memberIndex].points.pPoint || 0) + pPointAmount;
                localStorage.setItem('weverseMembers', JSON.stringify(members));

                // Mark order as processed
                const orders = JSON.parse(localStorage.getItem('weverseOrders')) || [];
                const orderIndex = orders.findIndex(o => o.id === orderId);
                if (orderIndex !== -1) {
                    orders[orderIndex].pvProcessed = true;
                    orders[orderIndex].pvProcessDate = new Date().toISOString();
                    orders[orderIndex].pvEarnedAmount = pPointAmount;
                    localStorage.setItem('weverseOrders', JSON.stringify(orders));
                }

                // Add transaction
                await weverseData.addPointTransaction({
                    memberId: memberId,
                    pointType: 'pPoint',
                    type: 'PV적립',
                    amount: pPointAmount,
                    description: `주문 #${orderId} PV 적립 (${Math.floor(pPointAmount / earningRate)} PV × ${earningRate * 100}%)`
                });

                return { success: true };
            } catch (error) {
                console.error('Error processing P-point earning:', error);
                return { success: false, error: '처리 중 오류가 발생했습니다.' };
            }
        }

        // Render earning history
        async function renderEarningHistory() {
            const orders = await weverseData.getOrders();
            const members = await weverseData.getMembers();

            // Filter processed orders
            const processedOrders = orders.filter(o => o.pvProcessed).sort((a, b) => {
                return new Date(b.pvProcessDate || b.orderDate) - new Date(a.pvProcessDate || a.orderDate);
            }).slice(0, 10);

            const tbody = document.getElementById('earningHistoryBody');

            if (processedOrders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">적립 내역이 없습니다.</td></tr>';
                return;
            }

            tbody.innerHTML = processedOrders.map(order => {
                const member = members.find(m => m.id === order.memberId);
                const processDate = order.pvProcessDate
                    ? new Date(order.pvProcessDate).toLocaleDateString('ko-KR')
                    : '-';
                const earnedAmount = order.pvEarnedAmount || Math.floor(order.totalPV * earningRate);

                return `
                    <tr>
                        <td>${processDate}</td>
                        <td><strong>#${order.id}</strong></td>
                        <td>${member?.name || '-'}</td>
                        <td class="pv-highlight">${order.totalPV} PV</td>
                        <td class="ppoint-highlight">$${earnedAmount}</td>
                    </tr>
                `;
            }).join('');
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            initEarningPage();
        });
    </script>
</body>
</html>
